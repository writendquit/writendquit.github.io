---
// Digital Ambience - Minecraft butterfly that feeds on RAM/cookies + Matrix rain idle effect
---

<!-- Floating Clouds Container (Left Side) -->
<div id="clouds-container" class="fixed left-0 top-1/4 z-40 pointer-events-none">
  <!-- Cloud 1 - UTC Time -->
  <div class="cloud cloud-1 opacity-0" style="transform: translateX(-100%);">
    <div class="cloud-glass">
      <div class="cloud-shape"></div>
      <div class="cloud-content">
        <div class="cloud-label">UTC TIME</div>
        <div id="utc-time" class="cloud-value font-mono">--:--:--</div>
        <div id="utc-date" class="cloud-date">----/--/--</div>
      </div>
    </div>
  </div>
  
  <!-- Cloud 2 - Local Time -->
  <div class="cloud cloud-2 opacity-0" style="transform: translateX(-100%);">
    <div class="cloud-glass">
      <div class="cloud-shape"></div>
      <div class="cloud-content">
        <div class="cloud-label">LOCAL TIME</div>
        <div id="local-time" class="cloud-value font-mono">--:--:--</div>
        <div id="local-zone" class="cloud-date">Timezone</div>
      </div>
    </div>
  </div>
  
  <!-- Cloud 3 - Status -->
  <div class="cloud cloud-3 opacity-0" style="transform: translateX(-100%);">
    <div class="cloud-glass">
      <div class="cloud-shape"></div>
      <div class="cloud-content">
        <div class="cloud-label">STATUS</div>
        <div class="cloud-status">
          <span class="status-dot"></span>
          <span id="connection-status">Online</span>
        </div>
        <div id="uptime" class="cloud-date">Session: 0s</div>
      </div>
    </div>
  </div>
</div>

<!-- Single Minecraft-Style Pixel Butterfly -->
<div id="minecraft-butterfly" class="fixed z-40 pointer-events-none" style="bottom: 100px; right: 100px;">
  <div class="mc-butterfly">
    <!-- Left Wing with Data -->
    <div class="mc-wing mc-wing-left">
      <div class="wing-pixels">
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-3);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
      </div>
      <!-- Data overlay on wing -->
      <div class="wing-data-overlay">
        <span id="mc-browser" class="mc-data">--</span>
        <span id="mc-screen" class="mc-data">--</span>
      </div>
    </div>
    
    <!-- Body (Pixelated) -->
    <div class="mc-body">
      <div class="body-pixel"></div>
      <div class="body-pixel"></div>
      <div class="body-pixel"></div>
      <div class="body-pixel head"></div>
      <!-- Antennae -->
      <div class="mc-antenna mc-antenna-left"></div>
      <div class="mc-antenna mc-antenna-right"></div>
    </div>
    
    <!-- Right Wing with Data -->
    <div class="mc-wing mc-wing-right">
      <div class="wing-pixels">
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-3);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
          <div class="pixel" style="background: var(--wing-color-2);"></div>
        </div>
        <div class="pixel-row">
          <div class="pixel" style="background: var(--wing-color-2);"></div>
          <div class="pixel" style="background: var(--wing-color-1);"></div>
        </div>
      </div>
      <!-- Data overlay on wing -->
      <div class="wing-data-overlay">
        <span id="mc-os" class="mc-data">--</span>
        <span id="mc-visitors" class="mc-data">--</span>
      </div>
    </div>
  </div>
  
  <!-- Tooltip that follows butterfly -->
  <div id="butterfly-tooltip" class="mc-tooltip">
    <div class="tooltip-header">Digital Butterfly</div>
    <div class="tooltip-row"><span class="tooltip-label">Browser:</span> <span id="tip-browser">--</span></div>
    <div class="tooltip-row"><span class="tooltip-label">Screen:</span> <span id="tip-screen">--</span></div>
    <div class="tooltip-row"><span class="tooltip-label">OS:</span> <span id="tip-os">--</span></div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-row"><span class="tooltip-label">RAM Used:</span> <span id="tip-ram" class="text-green-400">--</span></div>
    <div class="tooltip-row"><span class="tooltip-label">Cookies:</span> <span id="tip-cookies" class="text-yellow-400">--</span></div>
    <div class="tooltip-row"><span class="tooltip-label">Size:</span> <span id="tip-size" class="text-cyan-400">--</span></div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-row"><span class="tooltip-label">Visitors:</span> <span id="tip-visitors">--</span></div>
    <div class="tooltip-footer">Feeds on RAM & Cookies</div>
  </div>
</div>

<!-- Toggle Button -->
<button id="toggle-ambience" class="fixed right-4 top-20 z-50 p-2 bg-background/80 backdrop-blur-md border rounded-full shadow-lg hover:scale-110 transition-all group" title="Toggle Digital Ambience">
  <svg class="w-5 h-5 text-foreground group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2" />
    <path d="M19 11h2m-1 -1v2" />
  </svg>
</button>

<!-- Neo's Screen - Terminal Style -->
<div id="matrix-container" class="fixed inset-0 z-[9999] pointer-events-none opacity-0">
  <div id="neo-screen" class="absolute inset-0 bg-black overflow-hidden">
    <div class="neo-terminal" id="neo-terminal">
      <pre id="neo-text" class="neo-text"></pre><span id="neo-cursor" class="neo-cursor">_</span>
    </div>
  </div>
</div>

<style>
  /* Minecraft color palette */
  :root {
    --wing-color-1: rgba(138, 180, 248, 0.7);
    --wing-color-2: rgba(100, 149, 237, 0.5);
    --wing-color-3: rgba(255, 255, 255, 0.8);
    --pixel-size: 6px;
  }
  
  /* Cloud Styles */
  .cloud {
    position: absolute;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .cloud-1 { top: 0; left: 10px; animation-delay: 0s; }
  .cloud-2 { top: 90px; left: 25px; animation-delay: 0.3s; }
  .cloud-3 { top: 180px; left: 5px; animation-delay: 0.6s; }
  
  .cloud.visible {
    opacity: 1;
    transform: translateX(0) !important;
  }
  
  .cloud-glass {
    position: relative;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 20px 20px 20px 5px;
    box-shadow: 
      0 8px 32px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255,255,255,0.2);
    min-width: 120px;
  }
  
  .cloud-shape {
    position: absolute;
    top: -8px;
    left: 15px;
    width: 30px;
    height: 20px;
    background: inherit;
    border-radius: 50%;
    filter: blur(2px);
    opacity: 0.5;
  }
  
  .cloud-label {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--foreground);
    opacity: 0.5;
    margin-bottom: 2px;
  }
  
  .cloud-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--foreground);
    line-height: 1.2;
  }
  
  .cloud-date {
    font-size: 9px;
    color: var(--foreground);
    opacity: 0.6;
    margin-top: 2px;
  }
  
  .cloud-status {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    animation: pulse-status 2s ease-in-out infinite;
    box-shadow: 0 0 8px #22c55e;
  }
  
  @keyframes pulse-status {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.2); }
  }
  
  /* Cloud float animation */
  .cloud.visible {
    animation: cloud-float 6s ease-in-out infinite;
  }
  
  .cloud-1.visible { animation-delay: 0s; }
  .cloud-2.visible { animation-delay: 2s; }
  .cloud-3.visible { animation-delay: 4s; }
  
  @keyframes cloud-float {
    0%, 100% { transform: translateX(0) translateY(0); }
    25% { transform: translateX(5px) translateY(-3px); }
    50% { transform: translateX(0) translateY(-5px); }
    75% { transform: translateX(-3px) translateY(-2px); }
  }
  
  /* ===== MINECRAFT BUTTERFLY ===== */
  #minecraft-butterfly {
    transition: all 0.1s linear;
    image-rendering: pixelated;
    pointer-events: auto;
    cursor: pointer;
  }
  
  .mc-butterfly {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transform-style: preserve-3d;
    perspective: 200px;
  }
  
  /* Pixelated Body */
  .mc-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
    position: relative;
  }
  
  .body-pixel {
    width: var(--pixel-size);
    height: var(--pixel-size);
    background: #1a1a1a;
    box-shadow: 
      inset 1px 1px 0 rgba(255,255,255,0.2),
      inset -1px -1px 0 rgba(0,0,0,0.3);
  }
  
  .body-pixel.head {
    width: calc(var(--pixel-size) * 1.2);
    height: calc(var(--pixel-size) * 1.2);
    border-radius: 1px;
  }
  
  /* Pixelated Antennae */
  .mc-antenna {
    position: absolute;
    width: 2px;
    height: 10px;
    background: #1a1a1a;
    top: -8px;
  }
  
  .mc-antenna-left {
    left: -3px;
    transform: rotate(-30deg);
  }
  
  .mc-antenna-right {
    right: -3px;
    transform: rotate(30deg);
  }
  
  .mc-antenna::after {
    content: '';
    position: absolute;
    top: -3px;
    left: -1px;
    width: 4px;
    height: 4px;
    background: #1a1a1a;
  }
  
  /* Pixel Wings */
  .mc-wing {
    position: relative;
    transform-origin: center;
    transform-style: preserve-3d;
  }
  
  .mc-wing-left {
    transform-origin: right center;
    animation: mc-flap-left 0.3s ease-in-out infinite;
  }
  
  .mc-wing-right {
    transform-origin: left center;
    animation: mc-flap-right 0.3s ease-in-out infinite;
  }
  
  .wing-pixels {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  
  .mc-wing-right .wing-pixels {
    align-items: flex-start;
  }
  
  .pixel-row {
    display: flex;
  }
  
  .mc-wing-left .pixel-row {
    justify-content: flex-end;
  }
  
  .pixel {
    width: var(--pixel-size);
    height: var(--pixel-size);
    box-shadow: 
      inset 1px 1px 0 rgba(255,255,255,0.4),
      inset -1px -1px 0 rgba(0,0,0,0.2);
    image-rendering: pixelated;
  }
  
  /* Wing data overlay - glassmorphism on wings */
  .wing-data-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }
  
  .mc-data {
    font-size: 6px;
    font-family: 'Courier New', monospace;
    color: #fff;
    text-shadow: 1px 1px 0 #000;
    white-space: nowrap;
  }
  
  /* Minecraft-style flapping */
  @keyframes mc-flap-left {
    0%, 100% { transform: rotateY(0deg) rotateX(5deg); }
    50% { transform: rotateY(70deg) rotateX(-10deg); }
  }
  
  @keyframes mc-flap-right {
    0%, 100% { transform: rotateY(0deg) rotateX(5deg); }
    50% { transform: rotateY(-70deg) rotateX(-10deg); }
  }
  
  /* Tooltip - Minecraft style */
  .mc-tooltip {
    position: absolute;
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(16, 0, 16, 0.94);
    border: 2px solid #5c005c;
    padding: 6px 10px;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    color: #fff;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
    box-shadow: 
      inset 0 0 0 1px rgba(255,255,255,0.1),
      0 4px 12px rgba(0,0,0,0.5);
  }
  
  .mc-tooltip::before {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #5c005c;
  }
  
  #minecraft-butterfly:hover .mc-tooltip {
    opacity: 1;
  }
  
  .tooltip-row {
    display: flex;
    gap: 6px;
    line-height: 1.4;
  }
  
  .tooltip-label {
    color: #aaa;
  }
  
  /* Butterfly flying around the screen */
  #minecraft-butterfly {
    animation: mc-fly 20s ease-in-out infinite;
  }
  
  @keyframes mc-fly {
    0% { 
      bottom: 100px; 
      right: 100px; 
      transform: rotate(0deg);
    }
    10% { 
      bottom: 200px; 
      right: 150px; 
      transform: rotate(-5deg);
    }
    20% { 
      bottom: 300px; 
      right: 80px; 
      transform: rotate(8deg);
    }
    30% { 
      bottom: 250px; 
      right: 200px; 
      transform: rotate(-3deg);
    }
    40% { 
      bottom: 400px; 
      right: 120px; 
      transform: rotate(10deg);
    }
    50% { 
      bottom: 350px; 
      right: 250px; 
      transform: rotate(-8deg);
    }
    60% { 
      bottom: 200px; 
      right: 300px; 
      transform: rotate(5deg);
    }
    70% { 
      bottom: 150px; 
      right: 180px; 
      transform: rotate(-10deg);
    }
    80% { 
      bottom: 250px; 
      right: 50px; 
      transform: rotate(3deg);
    }
    90% { 
      bottom: 180px; 
      right: 120px; 
      transform: rotate(-5deg);
    }
    100% { 
      bottom: 100px; 
      right: 100px; 
      transform: rotate(0deg);
    }
  }
  
  /* Pause on hover */
  #minecraft-butterfly:hover {
    animation-play-state: paused;
  }
  
  #minecraft-butterfly:hover .mc-wing-left,
  #minecraft-butterfly:hover .mc-wing-right {
    animation-play-state: paused;
  }
  
  /* Hidden state */
  #clouds-container.hidden,
  #minecraft-butterfly.hidden {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    #minecraft-butterfly {
      transform: scale(0.8);
    }
    
    #clouds-container {
      transform: scale(0.8);
      transform-origin: top left;
    }
  }
  
  @media (max-width: 480px) {
    #minecraft-butterfly {
      display: none;
    }
  }
  
  /* ===== NEO'S SCREEN ===== */
  #matrix-container.active {
    opacity: 1;
    pointer-events: auto;
  }
  
  #neo-screen {
    background: #000;
  }
  
  .neo-terminal {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    color: #33ff33;
  }
  
  .neo-text {
    margin: 0;
    padding: 0;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    display: inline;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  .neo-cursor {
    color: #33ff33;
    font-weight: bold;
    animation: neo-blink 0.7s step-end infinite;
  }
  
  @keyframes neo-blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }
  
  /* Butterfly color transition based on position */
  #minecraft-butterfly {
    --hue: 210;
    filter: hue-rotate(calc(var(--hue) * 1deg));
    transition: filter 0.5s ease, transform 0.3s ease;
  }
  
  /* Butterfly breathing/pulsing based on size */
  @keyframes butterfly-breathe {
    0%, 100% { transform: scale(var(--butterfly-scale, 1)); }
    50% { transform: scale(calc(var(--butterfly-scale, 1) * 1.05)); }
  }
  
  .mc-butterfly {
    animation: butterfly-breathe 2s ease-in-out infinite;
  }
  
  /* Tooltip enhancements */
  .tooltip-header {
    font-size: 11px;
    font-weight: bold;
    color: #fff;
    text-align: center;
    margin-bottom: 4px;
    padding-bottom: 4px;
    border-bottom: 1px solid #5c005c;
  }
  
  .tooltip-divider {
    height: 1px;
    background: #5c005c;
    margin: 4px 0;
  }
  
  .tooltip-footer {
    font-size: 8px;
    color: #888;
    text-align: center;
    margin-top: 4px;
    font-style: italic;
  }
  
  .text-green-400 { color: #4ade80; }
  .text-yellow-400 { color: #facc15; }
  .text-cyan-400 { color: #22d3ee; }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const cloudsContainer = document.getElementById('clouds-container')
    const butterflyEl = document.getElementById('minecraft-butterfly')
    const toggleBtn = document.getElementById('toggle-ambience')
    
    // Neo's screen elements
    const matrixContainer = document.getElementById('matrix-container')
    const neoText = document.getElementById('neo-text')
    const neoCursor = document.getElementById('neo-cursor')
    
    // Cloud elements
    const utcTime = document.getElementById('utc-time')
    const utcDate = document.getElementById('utc-date')
    const localTime = document.getElementById('local-time')
    const localZone = document.getElementById('local-zone')
    const uptime = document.getElementById('uptime')
    
    // Butterfly tooltip elements
    const tipBrowser = document.getElementById('tip-browser')
    const tipScreen = document.getElementById('tip-screen')
    const tipOs = document.getElementById('tip-os')
    const tipVisitors = document.getElementById('tip-visitors')
    const tipRam = document.getElementById('tip-ram')
    const tipCookies = document.getElementById('tip-cookies')
    const tipSize = document.getElementById('tip-size')
    
    // Butterfly wing data
    const mcBrowser = document.getElementById('mc-browser')
    const mcScreen = document.getElementById('mc-screen')
    const mcOs = document.getElementById('mc-os')
    const mcVisitors = document.getElementById('mc-visitors')
    
    if (!cloudsContainer || !butterflyEl) return
    
    let sessionStart = Date.now()
    let isVisible = localStorage.getItem('hideAmbience') !== 'true'
    let idleTimer: number | null = null
    let matrixActive = false
    let lastActivityTime = Date.now()
    const IDLE_TIMEOUT = 11000 // 11 seconds
    
    // Butterfly state
    let butterflyHue = 210
    let butterflyScale = 1
    let ramUsed = 0
    let cookieCount = 0
    
    // Initialize visibility
    if (!isVisible) {
      cloudsContainer.classList.add('hidden')
      butterflyEl.classList.add('hidden')
    }
    
    // ===== NEO'S SCREEN - SEARCH DATA + MESSAGES =====
    
    // Search results / data that scrolls first (like in the movie)
    const searchData = [
      'SEARCH: MORPHEUS',
      '',
      '> Searching global database...',
      '> Connection established: NODE 7749-B',
      '',
      'CLASSIFIED - LEVEL 5 CLEARANCE REQUIRED',
      '=========================================',
      '',
      'Subject: MORPHEUS',
      'Status: ACTIVE THREAT',
      'Known Aliases: The One Who Knows, Captain',
      'Last Known Location: [REDACTED]',
      '',
      'INTERPOL BULLETIN #445-7721:',
      'Wanted for cyber terrorism, data theft,',
      'unauthorized system access. Considered',
      'extremely dangerous. Do not approach.',
      '',
      'FBI CASE FILE #MT-2199:',
      'Connection to underground network confirmed.',
      'Manhattan Project files accessed illegally.',
      'Multiple government systems compromised.',
      '',
      'NSA INTERCEPT LOG:',
      '> "He\'s looking for something..."',
      '> "The One? That\'s just a legend..."',
      '> "Morpheus believes. That makes him dangerous."',
      '',
      'RELATED SEARCHES:',
      '- The Matrix (meaning unknown)',
      '- Red pill / Blue pill (code phrase?)',
      '- Nebuchadnezzar (vessel ID?)',
      '- Zion (location unconfirmed)',
      '',
      '=========================================',
      'END SEARCH RESULTS',
      '=========================================',
      '',
      '',
      ''
    ]
    
    // Final messages that appear after search data
    const neoMessages = [
      'Wake up, Neo...',
      'The Matrix has you...',
      'Follow the white rabbit.',
      'Knock, knock, Neo.'
    ]
    
    let typingTimeout: number | null = null
    let phase: 'search' | 'clear' | 'messages' = 'search'
    let lineIndex = 0
    let charIndex = 0
    let displayedText = ''
    
    const typeNextChar = () => {
      if (!matrixActive || !neoText) return
      
      if (phase === 'search') {
        // Phase 1: Type search data quickly
        if (lineIndex < searchData.length) {
          const currentLine = searchData[lineIndex]
          
          if (charIndex < currentLine.length) {
            displayedText += currentLine[charIndex]
            neoText.textContent = displayedText
            charIndex++
            typingTimeout = window.setTimeout(typeNextChar, 8 + Math.random() * 12) // Fast typing
          } else {
            // Line complete, move to next
            displayedText += '\n'
            neoText.textContent = displayedText
            charIndex = 0
            lineIndex++
            typingTimeout = window.setTimeout(typeNextChar, 50 + Math.random() * 100) // Brief pause between lines
          }
        } else {
          // Search data complete, pause then clear
          phase = 'clear'
          typingTimeout = window.setTimeout(typeNextChar, 1500)
        }
      } else if (phase === 'clear') {
        // Phase 2: Clear screen
        displayedText = ''
        neoText.textContent = ''
        lineIndex = 0
        charIndex = 0
        phase = 'messages'
        typingTimeout = window.setTimeout(typeNextChar, 800)
      } else if (phase === 'messages') {
        // Phase 3: Type the famous messages slowly
        if (lineIndex < neoMessages.length) {
          const currentMessage = neoMessages[lineIndex]
          
          if (charIndex < currentMessage.length) {
            displayedText += currentMessage[charIndex]
            neoText.textContent = displayedText
            charIndex++
            typingTimeout = window.setTimeout(typeNextChar, 80 + Math.random() * 40) // Slower, deliberate typing
          } else {
            // Message complete
            charIndex = 0
            lineIndex++
            
            if (lineIndex < neoMessages.length) {
              displayedText += '\n\n'
              neoText.textContent = displayedText
              typingTimeout = window.setTimeout(typeNextChar, 2500) // Long pause between messages
            }
            // Done - cursor keeps blinking
          }
        }
      }
    }
    
    const startNeoScreen = () => {
      if (matrixActive) return
      matrixActive = true
      
      // Reset state
      phase = 'search'
      lineIndex = 0
      charIndex = 0
      displayedText = ''
      
      if (neoText) neoText.textContent = ''
      
      matrixContainer?.classList.add('active')
      
      // Start after cursor blinks briefly
      typingTimeout = window.setTimeout(typeNextChar, 500)
    }
    
    const stopNeoScreen = () => {
      matrixActive = false
      
      if (typingTimeout) {
        clearTimeout(typingTimeout)
        typingTimeout = null
      }
      
      matrixContainer?.classList.remove('active')
      
      if (neoText) neoText.textContent = ''
      displayedText = ''
      phase = 'search'
      lineIndex = 0
      charIndex = 0
      
      resetIdleTimer()
    }
    
    // Exit on click or ESC
    matrixContainer?.addEventListener('click', stopNeoScreen)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && matrixActive) {
        stopNeoScreen()
      }
    })
    
    // Idle detection
    const resetIdleTimer = () => {
      lastActivityTime = Date.now()
      if (idleTimer) {
        clearTimeout(idleTimer)
      }
      if (!matrixActive) {
        idleTimer = window.setTimeout(() => {
          startNeoScreen()
        }, IDLE_TIMEOUT)
      }
    }
    
    // Activity listeners
    const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click']
    activityEvents.forEach(event => {
      document.addEventListener(event, () => {
        if (!matrixActive) {
          resetIdleTimer()
        }
      }, { passive: true })
    })
    
    // ===== BUTTERFLY FEEDING ON RAM & COOKIES =====
    const updateButterflySize = () => {
      // Get RAM usage (if available)
      const perf = (performance as any)
      if (perf.memory) {
        ramUsed = Math.round(perf.memory.usedJSHeapSize / (1024 * 1024))
      } else {
        // Estimate based on DOM size
        ramUsed = Math.round(document.documentElement.outerHTML.length / 1024)
      }
      
      // Count cookies
      cookieCount = document.cookie ? document.cookie.split(';').length : 0
      
      // Calculate butterfly scale based on RAM + cookies
      // More RAM/cookies = bigger butterfly (feeds on them)
      const ramFactor = Math.min(ramUsed / 50, 2) // Max 2x from RAM
      const cookieFactor = Math.min(cookieCount / 5, 1) // Max 1x from cookies
      butterflyScale = 0.8 + (ramFactor * 0.3) + (cookieFactor * 0.2)
      butterflyScale = Math.min(butterflyScale, 2) // Cap at 2x
      
      // Apply scale
      butterflyEl.style.setProperty('--butterfly-scale', butterflyScale.toString())
      
      // Update tooltip
      if (tipRam) tipRam.textContent = `${ramUsed}MB`
      if (tipCookies) tipCookies.textContent = `${cookieCount} cookies`
      if (tipSize) tipSize.textContent = `${Math.round(butterflyScale * 100)}%`
    }
    
    // ===== BUTTERFLY COLOR CHANGE ON MOVEMENT =====
    let lastButterflyPos = { x: 0, y: 0 }
    
    const updateButterflyColor = () => {
      const rect = butterflyEl.getBoundingClientRect()
      const x = rect.left
      const y = rect.top
      
      // Calculate hue based on position (0-360)
      const screenDiagonal = Math.sqrt(window.innerWidth ** 2 + window.innerHeight ** 2)
      const posDiagonal = Math.sqrt(x ** 2 + y ** 2)
      butterflyHue = (posDiagonal / screenDiagonal) * 360
      
      // Apply hue rotation
      butterflyEl.style.setProperty('--hue', butterflyHue.toString())
      
      lastButterflyPos = { x, y }
    }
    
    // Track butterfly position and update color
    const butterflyColorInterval = setInterval(updateButterflyColor, 100)
    
    // Toggle handler
    toggleBtn?.addEventListener('click', () => {
      isVisible = !isVisible
      localStorage.setItem('hideAmbience', (!isVisible).toString())
      
      if (isVisible) {
        cloudsContainer.classList.remove('hidden')
        butterflyEl.classList.remove('hidden')
        showClouds()
      } else {
        cloudsContainer.classList.add('hidden')
        butterflyEl.classList.add('hidden')
      }
    })
    
    // Show clouds with delay
    const showClouds = () => {
      const clouds = document.querySelectorAll('.cloud')
      clouds.forEach((cloud, i) => {
        setTimeout(() => {
          cloud.classList.add('visible')
        }, i * 200 + 500)
      })
    }
    
    // Update time displays
    const updateTime = () => {
      const now = new Date()
      
      // UTC Time
      if (utcTime) {
        utcTime.textContent = now.toUTCString().split(' ')[4]
      }
      if (utcDate) {
        utcDate.textContent = now.toISOString().split('T')[0]
      }
      
      // Local Time
      if (localTime) {
        localTime.textContent = now.toLocaleTimeString('en-US', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        })
      }
      if (localZone) {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone
        localZone.textContent = tz.replace('_', ' ')
      }
      
      // Uptime
      if (uptime) {
        const elapsed = Math.floor((Date.now() - sessionStart) / 1000)
        const mins = Math.floor(elapsed / 60)
        const secs = elapsed % 60
        uptime.textContent = mins > 0 ? `Session: ${mins}m ${secs}s` : `Session: ${secs}s`
      }
    }
    
    // Get browser info
    const getBrowserInfo = () => {
      const ua = navigator.userAgent
      let browser = 'Unknown'
      let version = ''
      
      if (ua.includes('Firefox/')) {
        browser = 'Firefox'
        version = ua.split('Firefox/')[1]?.split(' ')[0] || ''
      } else if (ua.includes('Chrome/') && !ua.includes('Edg/')) {
        browser = 'Chrome'
        version = ua.split('Chrome/')[1]?.split(' ')[0] || ''
      } else if (ua.includes('Safari/') && !ua.includes('Chrome/')) {
        browser = 'Safari'
        version = ua.split('Version/')[1]?.split(' ')[0] || ''
      } else if (ua.includes('Edg/')) {
        browser = 'Edge'
        version = ua.split('Edg/')[1]?.split(' ')[0] || ''
      } else if (ua.includes('Opera/') || ua.includes('OPR/')) {
        browser = 'Opera'
        version = ua.split('OPR/')[1]?.split(' ')[0] || ''
      }
      
      const browserText = `${browser} ${version.split('.')[0]}`
      if (tipBrowser) tipBrowser.textContent = browserText
      if (mcBrowser) mcBrowser.textContent = browser
      
      return browserText
    }
    
    // Get screen info
    const getScreenInfo = () => {
      const screenText = `${window.innerWidth}x${window.innerHeight}`
      if (tipScreen) tipScreen.textContent = screenText
      if (mcScreen) mcScreen.textContent = screenText
      
      return screenText
    }
    
    // Get OS info
    const getOSInfo = () => {
      const ua = navigator.userAgent
      let os = 'Unknown'
      let device = 'Desktop'
      
      if (ua.includes('Windows')) os = 'Windows'
      else if (ua.includes('Mac')) os = 'macOS'
      else if (ua.includes('Linux') && !ua.includes('Android')) os = 'Linux'
      else if (ua.includes('Android')) { os = 'Android'; device = 'Mobile' }
      else if (ua.includes('iPhone') || ua.includes('iPad')) { 
        os = 'iOS'
        device = ua.includes('iPad') ? 'Tablet' : 'Mobile'
      }
      
      const osText = `${os} (${device})`
      if (tipOs) tipOs.textContent = osText
      if (mcOs) mcOs.textContent = os
      
      return osText
    }
    
    // Get visitor count
    const getVisitorCount = () => {
      const key = 'site_visitors_ambience'
      let count = parseInt(localStorage.getItem(key) || '0')
      const sessionKey = 'session_ambience'
      
      if (!sessionStorage.getItem(sessionKey)) {
        count++
        localStorage.setItem(key, count.toString())
        sessionStorage.setItem(sessionKey, '1')
      }
      
      const visitorCount = count + 389
      if (tipVisitors) tipVisitors.textContent = visitorCount.toString()
      if (mcVisitors) mcVisitors.textContent = visitorCount.toString()
      
      return visitorCount
    }
    
    // Update screen size on resize
    window.addEventListener('resize', () => {
      getScreenInfo()
      if (matrixActive) {
        initMatrix()
      }
    })
    
    // Initialize
    if (isVisible) {
      showClouds()
    }
    
    getBrowserInfo()
    getScreenInfo()
    getOSInfo()
    getVisitorCount()
    updateButterflySize()
    updateTime()
    
    // Start idle timer
    resetIdleTimer()
    
    // Update time every second
    setInterval(updateTime, 1000)
    
    // Update butterfly size periodically (feeding)
    setInterval(updateButterflySize, 5000)
  })
</script>
