---
---

<!-- Matrix Rain Effect -->
<canvas id="matrix-rain" class="fixed inset-0 z-[150] pointer-events-none opacity-0 transition-opacity duration-1000"></canvas>

<div id="rabbit-container" class="fixed z-[200] pointer-events-none transition-all duration-75" style="left: 20px; top: 50px;">
  <div id="rabbit-character" class="pointer-events-auto cursor-pointer transition-transform duration-150 hover:scale-125">
    <!-- Tiny Cute Alice -->
    <div class="rabbit-body relative w-8 h-10 drop-shadow-[0_0_6px_rgba(255,255,255,0.8)]">
      <!-- Ears -->
      <div class="absolute -top-5 left-0.5 w-1 h-5 bg-white rounded-full transform -rotate-6 origin-bottom ear-left shadow-[0_0_4px_rgba(255,255,255,0.6)]"></div>
      <div class="absolute -top-5 right-0.5 w-1 h-5 bg-white rounded-full transform rotate-6 origin-bottom ear-right shadow-[0_0_4px_rgba(255,255,255,0.6)]"></div>
      <div class="absolute -top-4 left-0.5 w-0.5 h-3 bg-pink-200 rounded-full transform -rotate-6"></div>
      <div class="absolute -top-4 right-0.5 w-0.5 h-3 bg-pink-200 rounded-full transform rotate-6"></div>
      
      <!-- Head -->
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-5 bg-white rounded-full shadow-[0_0_8px_rgba(255,255,255,0.5)]"></div>
      
      <!-- Eyes -->
      <div class="absolute top-1.5 left-1.5 w-1 h-1 bg-red-500 rounded-full eye-left shadow-[0_0_3px_rgba(239,68,68,0.8)]"></div>
      <div class="absolute top-1.5 right-1.5 w-1 h-1 bg-red-500 rounded-full eye-right shadow-[0_0_3px_rgba(239,68,68,0.8)]"></div>
      
      <!-- Nose -->
      <div class="absolute top-3 left-1/2 -translate-x-1/2 w-1 h-0.5 bg-pink-300 rounded-full nose"></div>
      
      <!-- Whiskers -->
      <div class="absolute top-3 left-0 w-2 h-px bg-gray-300/70"></div>
      <div class="absolute top-3 right-0 w-2 h-px bg-gray-300/70"></div>
      
      <!-- Body -->
      <div class="absolute top-4 left-1/2 -translate-x-1/2 w-5 h-5 bg-white rounded-full shadow-[0_0_6px_rgba(255,255,255,0.4)]"></div>
      
      <!-- Feet -->
      <div class="absolute bottom-0 left-0.5 w-2 h-1 bg-white rounded-full foot-left"></div>
      <div class="absolute bottom-0 right-0.5 w-2 h-1 bg-white rounded-full foot-right"></div>
      
      <!-- Tail -->
      <div class="absolute bottom-1 -right-1 w-2 h-2 bg-white rounded-full tail"></div>
    </div>
  </div>
  
  <!-- Name tag -->
  <div id="alice-name" class="absolute -top-4 left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-200">
    <span class="text-[8px] font-mono text-green-400 bg-black/80 px-1 rounded">Alice</span>
  </div>
  
  <!-- Speech Bubble -->
  <div id="rabbit-speech" class="absolute -top-16 left-1/2 -translate-x-1/2 opacity-0 transition-all duration-300 pointer-events-auto">
    <div class="relative bg-black/90 border border-green-500 rounded-lg px-2 py-1.5 min-w-[120px] max-w-[160px] shadow-[0_0_10px_rgba(34,197,94,0.3)]">
      <p id="rabbit-message" class="text-[9px] text-center font-mono text-green-400"></p>
      
      <div id="pills-container" class="hidden mt-2 flex justify-center gap-2">
        <button id="red-pill" class="px-2 py-0.5 bg-red-600 hover:bg-red-500 text-white text-[8px] font-bold rounded-full">RED</button>
        <button id="blue-pill" class="px-2 py-0.5 bg-blue-600 hover:bg-blue-500 text-white text-[8px] font-bold rounded-full">BLUE</button>
      </div>
      
      <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black/90 border-r border-b border-green-500 transform rotate-45"></div>
    </div>
  </div>
</div>

<!-- The Rabbit Hole -->
<div id="the-well" class="fixed bottom-2 right-2 z-[199] opacity-0 transition-all duration-500 pointer-events-none">
  <div class="relative w-12 h-10">
    <div class="absolute bottom-0 w-12 h-3 bg-gradient-to-b from-gray-800 to-black rounded-full"></div>
    <div class="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-8 h-2 bg-black rounded-full"></div>
    <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-6 h-1 bg-green-500/30 rounded-full blur-sm animate-pulse"></div>
  </div>
</div>

<style>
  @keyframes run {
    0%, 100% { transform: translateY(0); }
    20% { transform: translateY(-4px) rotate(-2deg); }
    40% { transform: translateY(-6px); }
    60% { transform: translateY(-4px) rotate(2deg); }
    80% { transform: translateY(-2px); }
  }
  
  @keyframes idle-look {
    0%, 100% { transform: translateY(0) rotate(0); }
    30% { transform: translateY(-1px) rotate(-3deg); }
    70% { transform: translateY(-1px) rotate(3deg); }
  }
  
  @keyframes sniff {
    0%, 100% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.3); }
  }
  
  @keyframes alert-ears {
    0%, 100% { transform: rotate(-6deg); }
    50% { transform: rotate(-20deg) scaleY(1.1); }
  }
  
  @keyframes alert-ears-r {
    0%, 100% { transform: rotate(6deg); }
    50% { transform: rotate(20deg) scaleY(1.1); }
  }
  
  @keyframes tail-wag {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(2px); }
  }
  
  @keyframes blink {
    0%, 92%, 100% { transform: scaleY(1); }
    95%, 97% { transform: scaleY(0.1); }
  }
  
  #rabbit-character.running .rabbit-body { animation: run 0.25s ease-in-out infinite; }
  #rabbit-character.idle .rabbit-body { animation: idle-look 2s ease-in-out infinite; }
  #rabbit-character.alert .ear-left { animation: alert-ears 0.3s ease-in-out infinite; }
  #rabbit-character.alert .ear-right { animation: alert-ears-r 0.3s ease-in-out infinite; }
  #rabbit-character.sniffing .nose { animation: sniff 0.3s ease-in-out infinite; }
  #rabbit-character .tail { animation: tail-wag 0.5s ease-in-out infinite; }
  #rabbit-character .eye-left, #rabbit-character .eye-right { animation: blink 4s ease-in-out infinite; }
  
  #rabbit-character.facing-left { transform: scaleX(-1); }
  
  @keyframes fall { 
    0% { transform: scale(1) rotate(0); opacity: 1; }
    100% { transform: scale(0) rotate(720deg); opacity: 0; }
  }
  #rabbit-character.falling { animation: fall 1s ease-in forwards; }
  
  @keyframes glitch {
    0%, 100% { filter: none; }
    33% { filter: hue-rotate(90deg); transform: translate(-1px, 1px); }
    66% { filter: hue-rotate(180deg); transform: translate(1px, -1px); }
  }
  #rabbit-character.glitching { animation: glitch 0.1s linear infinite; }
</style>

<script>
  document.addEventListener('astro:page-load', initAlice)
  initAlice()
  
  function initAlice() {
    const container = document.getElementById('rabbit-container')
    const rabbit = document.getElementById('rabbit-character')
    const speech = document.getElementById('rabbit-speech')
    const message = document.getElementById('rabbit-message')
    const nameTag = document.getElementById('alice-name')
    const pillsContainer = document.getElementById('pills-container')
    const redPill = document.getElementById('red-pill')
    const bluePill = document.getElementById('blue-pill')
    const well = document.getElementById('the-well')
    const matrixCanvas = document.getElementById('matrix-rain') as HTMLCanvasElement
    
    if (!container || !rabbit || !speech || !message) return
    
    // State
    let posX = 20, posY = 50
    let targetX = posX, targetY = posY
    let edge = 0 // 0=top, 1=right, 2=bottom, 3=left
    let edgeProgress = 0
    let isPaused = false
    let isAlert = false
    let isTalking = false
    let isActive = true
    let lastActivity = Date.now()
    let pauseUntil = 0
    let currentSpeed = 2
    let messageTimeout: ReturnType<typeof setTimeout>
    
    const messages = [
      "Hi! I'm Alice~",
      "The Matrix has you...",
      "Wake up...",
      "Free your mind!",
      "There is no spoon.",
      "Curiouser and curiouser!",
      "I'm late! I'm late!",
      "Follow me~",
      "*sniff sniff*",
      "Hmm?",
      "...",
    ]
    
    const alertMessages = [
      "Oh! You moved!",
      "I see you~",
      "Hello there!",
      "*freeze*",
      "Eek!",
    ]
    
    const pillMessages = ["Red or blue?", "Choose wisely...", "Your choice."]
    
    // Get position along edge
    function getEdgePos(e: number, prog: number) {
      const w = window.innerWidth - 50
      const h = window.innerHeight - 60
      const p = 15
      switch(e) {
        case 0: return { x: p + prog * w, y: p }
        case 1: return { x: w + p, y: p + prog * h }
        case 2: return { x: w + p - prog * w, y: h + p }
        case 3: return { x: p, y: h + p - prog * h }
        default: return { x: p, y: p }
      }
    }
    
    // Update facing direction
    function updateFacing() {
      rabbit?.classList.remove('facing-left')
      if (edge === 2 || (edge === 0 && edgeProgress < 0.5) || edge === 3) {
        // Moving left or up-left
      } else {
        rabbit?.classList.add('facing-left')
      }
      // Simplified: face left when going left
      if (edge === 2) rabbit?.classList.add('facing-left')
      if (edge === 0) rabbit?.classList.remove('facing-left')
    }
    
    // Pause Alice
    function pauseFor(ms: number) {
      pauseUntil = Date.now() + ms
      isPaused = true
      rabbit?.classList.remove('running')
      rabbit?.classList.add('idle')
    }
    
    // Alert mode (when user does something)
    function triggerAlert() {
      if (isAlert || !isActive) return
      isAlert = true
      rabbit?.classList.add('alert', 'sniffing')
      rabbit?.classList.remove('running')
      
      // Random chance to say something
      if (Math.random() < 0.4 && !isTalking) {
        showMessage(alertMessages[Math.floor(Math.random() * alertMessages.length)])
      }
      
      // Pause for a bit
      pauseFor(800 + Math.random() * 1200)
      
      setTimeout(() => {
        isAlert = false
        rabbit?.classList.remove('alert', 'sniffing')
      }, 600)
    }
    
    // Main movement loop
    function moveAlice() {
      if (!isActive) {
        requestAnimationFrame(moveAlice)
        return
      }
      
      const now = Date.now()
      
      // Check if paused
      if (now < pauseUntil) {
        isPaused = true
        rabbit?.classList.remove('running')
        rabbit?.classList.add('idle')
        requestAnimationFrame(moveAlice)
        return
      }
      
      isPaused = false
      
      // Random pauses (natural behavior)
      if (Math.random() < 0.002) {
        pauseFor(500 + Math.random() * 2000)
        if (Math.random() < 0.3) {
          rabbit?.classList.add('sniffing')
          setTimeout(() => rabbit?.classList.remove('sniffing'), 800)
        }
        requestAnimationFrame(moveAlice)
        return
      }
      
      // Vary speed naturally
      if (Math.random() < 0.01) {
        currentSpeed = 1.5 + Math.random() * 2.5
      }
      
      // Move along edge
      edgeProgress += currentSpeed / 1000
      
      if (edgeProgress >= 1) {
        edgeProgress = 0
        edge = (edge + 1) % 4
        updateFacing()
        
        // Pause at corners sometimes
        if (Math.random() < 0.4) {
          pauseFor(300 + Math.random() * 700)
        }
      }
      
      const pos = getEdgePos(edge, edgeProgress)
      posX = pos.x
      posY = pos.y
      
      if (container) {
        container.style.left = `${posX}px`
        container.style.top = `${posY}px`
      }
      
      rabbit?.classList.add('running')
      rabbit?.classList.remove('idle')
      
      requestAnimationFrame(moveAlice)
    }
    
    // Show message
    function showMessage(text: string, showPills = false) {
      if (!message || !speech || !pillsContainer) return
      
      pauseFor(3000 + text.length * 50)
      
      message.textContent = ''
      let i = 0
      const typeInterval = setInterval(() => {
        if (i < text.length) {
          message.textContent += text[i]
          i++
        } else {
          clearInterval(typeInterval)
          if (showPills) pillsContainer.classList.remove('hidden')
        }
      }, 30)
      
      if (!showPills) pillsContainer.classList.add('hidden')
      speech.classList.remove('opacity-0')
      speech.classList.add('opacity-100')
      isTalking = true
      
      if (!showPills) {
        clearTimeout(messageTimeout)
        messageTimeout = setTimeout(hideMessage, 2500 + text.length * 40)
      }
    }
    
    function hideMessage() {
      if (!speech || !pillsContainer) return
      speech.classList.add('opacity-0')
      speech.classList.remove('opacity-100')
      pillsContainer.classList.add('hidden')
      isTalking = false
    }
    
    // Matrix rain
    function startMatrixRain() {
      if (!matrixCanvas) return
      const ctx = matrixCanvas.getContext('2d')
      if (!ctx) return
      
      const canvas = matrixCanvas, context = ctx
      canvas.width = window.innerWidth
      canvas.height = window.innerHeight
      canvas.classList.remove('opacity-0')
      canvas.classList.add('opacity-100')
      
      const chars = 'アイウエオ01MATRIX'
      const fontSize = 12
      const cols = Math.floor(canvas.width / fontSize)
      const drops = Array(cols).fill(0).map(() => Math.random() * -50)
      
      let frames = 0
      function draw() {
        if (frames++ > 200) { canvas.classList.add('opacity-0'); return }
        context.fillStyle = 'rgba(0,0,0,0.05)'
        context.fillRect(0, 0, canvas.width, canvas.height)
        context.fillStyle = '#0f0'
        context.font = `${fontSize}px monospace`
        drops.forEach((y, i) => {
          context.fillText(chars[Math.floor(Math.random() * chars.length)], i * fontSize, y * fontSize)
          if (y * fontSize > canvas.height && Math.random() > 0.98) drops[i] = 0
          else drops[i]++
        })
        requestAnimationFrame(draw)
      }
      draw()
    }
    
    // Event listeners
    
    // Scroll - pause and alert
    let scrollTimeout: ReturnType<typeof setTimeout>
    window.addEventListener('scroll', () => {
      triggerAlert()
      pauseFor(400)
      clearTimeout(scrollTimeout)
      scrollTimeout = setTimeout(() => {
        lastActivity = Date.now()
      }, 200)
    })
    
    // Mouse move - alert sometimes
    let moveCount = 0
    window.addEventListener('mousemove', () => {
      moveCount++
      if (moveCount % 50 === 0) { // Every 50 moves
        triggerAlert()
      }
      lastActivity = Date.now()
    })
    
    // Click anywhere
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement
      if (!target.closest('#rabbit-container')) {
        triggerAlert()
        pauseFor(600)
      }
    })
    
    // Hover on Alice - show name
    rabbit?.addEventListener('mouseenter', () => {
      nameTag?.classList.remove('opacity-0')
      nameTag?.classList.add('opacity-100')
      pauseFor(1000)
    })
    rabbit?.addEventListener('mouseleave', () => {
      nameTag?.classList.add('opacity-0')
      nameTag?.classList.remove('opacity-100')
    })
    
    // Click Alice
    rabbit?.addEventListener('click', (e) => {
      e.stopPropagation()
      if (!isTalking) {
        if (Math.random() < 0.25) {
          showMessage(pillMessages[Math.floor(Math.random() * pillMessages.length)], true)
        } else {
          showMessage(messages[Math.floor(Math.random() * messages.length)])
        }
      }
    })
    
    // Red pill
    redPill?.addEventListener('click', (e) => {
      e.stopPropagation()
      hideMessage()
      isActive = false
      startMatrixRain()
      showMessage("Down we go...")
      
      well?.classList.remove('opacity-0')
      well?.classList.add('opacity-100')
      
      setTimeout(() => {
        const wr = well?.getBoundingClientRect()
        if (wr && container) {
          container.style.transition = 'all 1.5s ease-in-out'
          container.style.left = `${wr.left}px`
          container.style.top = `${wr.top - 15}px`
        }
      }, 800)
      
      setTimeout(() => {
        hideMessage()
        rabbit?.classList.add('glitching')
        setTimeout(() => {
          rabbit?.classList.remove('glitching')
          rabbit?.classList.add('falling')
          setTimeout(() => {
            if (container) container.style.display = 'none'
            setTimeout(() => {
              if (container) {
                container.style.display = 'block'
                container.style.transition = 'all 0.075s'
                container.style.left = '20px'
                container.style.top = '50px'
              }
              rabbit?.classList.remove('falling')
              edge = 0
              edgeProgress = 0
              isActive = true
              well?.classList.add('opacity-0')
              setTimeout(() => showMessage("I'm back~"), 500)
            }, 3500)
          }, 1000)
        }, 400)
      }, 2500)
    })
    
    // Blue pill
    bluePill?.addEventListener('click', (e) => {
      e.stopPropagation()
      hideMessage()
      showMessage("Wheee~!")
    })
    
    // Random messages
    setInterval(() => {
      if (Math.random() < 0.06 && isActive && !isTalking && !isPaused) {
        showMessage(messages[Math.floor(Math.random() * messages.length)])
      }
    }, 20000)
    
    // Start
    updateFacing()
    moveAlice()
    setTimeout(() => showMessage("Hi! I'm Alice~"), 1500)
  }
</script>
